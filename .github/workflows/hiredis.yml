name: Build Hiredis

on:
  workflow_dispatch:

env:
  author: redis
  repo: hiredis
  workspace: ${{ github.workspace }}
  
jobs:
  build-hiredis:
    name: Build
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        configration: [release, debug]
        build_shared_libs: [shared, static]
        arch: [x64, x86]

    steps:
      - name: Install MSBuild
        uses: microsoft/setup-msbuild@main
        with:
          msbuild-architecture: ${{ matrix.arch }}
      - name: Install 7-Zip and Git using Chocolatey
        run: |
          choco install git 7zip.install -y
        shell: powershell
      
      - name: Clone Source
        run: |
          git clone https://github.com/${{ env.author }}/${{ env.repo }}.git ${{ github.workspace }}\${{ env.repo }}
          mkdir ${{ github.workspace }}\${{ env.repo }}\build
          
      - name: Run CMake
        run: |
          cd ${{ github.workspace }}\${{ env.repo }}\build

          if ( "${{ matrix.build_shared_libs }}" -eq "shared" ) {
            if ( "${{ matrix.arch }}" -eq "x64" ) {
              cmake .. -A x64 -Wno-dev
            } else {
              cmake .. -A win32 -Wno-dev
            }
          } else {
            if ( "${{ matrix.arch }}" -eq "x64" ) {
              cmake .. -A x64 -Wno-dev -DBUILD_SHARED_LIBS=OFF
            } else {
              cmake .. -A win32 -Wno-dev -DBUILD_SHARED_LIBS=OFF
            }
          }
          
      - name: Build Hiredis
        id: build
        run: |
          cd ${{ github.workspace }}\${{ env.repo }}\build
          
          if ( "${{ matrix.configration }}" -eq "release" ) {
            MSBuild hiredis.vcxproj /p:Configuration=Release /p:Platform=${{ matrix.arch }}
          } else {
            MSBuild hiredis.vcxproj /p:Configuration=Debug /p:Platform=${{ matrix.arch }}
          }

      - name: Prepare Upload
        continue-on-error: true
        if: steps.build.outcome == 'success'
        run: |
          cd ${{ github.workspace }}\${{ env.repo }}\build
          
          mkdir ${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}
          if ( "${{ matrix.configration }}" -eq "release" ) {
            Copy-Item .\Release\* .\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\ -Force
            Remove-item .\Release -Force -Recurse
          } else {
            Copy-Item .\Debug\* .\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\ -Force
            Remove-item .\Debug -Force -Recurse
          }
          
          cd ..
          7z a -tzip hiredis_include.zip hiredis.h read.h sds.h async.h alloc.h sockcompat.h adapters
          Copy-Item .\hiredis_include.zip .\build\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\hiredis_include.zip -Force

      - name: Release Hiredis
        continue-on-error: true
        if: steps.build.outcome == 'success'
        uses: ncipollo/release-action@main
        with:
          name: windows-${{ matrix.arch }}-${{ matrix.configration }}-${{ matrix.build_shared_libs }}
          tag: windows-${{ matrix.arch }}-${{ matrix.configration }}-${{ matrix.build_shared_libs }}
          token: ${{ secrets.GITHUB_TOKEN }}
          allowUpdates: true
          removeArtifacts: true
          artifacts: "${{ github.workspace }}\\${{ env.repo }}\\${{ matrix.configration }}-${{ matrix.build_shared_libs }}-${{ matrix.arch }}\\*.*"
          
      - name: Upload Artifacts
        continue-on-error: true
        if: steps.build.outcome == 'success'
        uses: actions/upload-artifact@v3
        with:
          name: "windows-${{ matrix.arch }}-${{ matrix.configration }}-${{ matrix.build_shared_libs }}"
          path:  |
            ${{ github.workspace }}